---
title: "KSPZV1 WGCNA Delta Postvax"
author: "Tuan M. Tran"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document :
    theme: cerulean
---

### Objective

Perform weighted gene correlation network analysis as originally described by Horvath et al. on delta (postvax/baseline) transcriptomic data from the KSPZV1 clinical trial.

References:

https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/Tutorials/
https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/JMiller/Tutorial%20document.pdf

Reviewer requested that we provide scatter plots for the correlations between modules and phenotypes. Review of the original code revealed that using Pearson's or Spearman's correlation to assess the relationship between modules and binary traits was not appropriate. Thus, for binary traits, we performed limma (empirical Bayes moderated t test) and presented differences as beeswarm plots with mean and 95%CI. For continuous variables, we performed Spearman's correlation.

### Load packages

```{r load packages, message=FALSE, warning=FALSE}
library(edgeR)
library(readxl)
library(EDASeq)
library(Biobase)
library(WGCNA)
library(ape)
library(Cairo)
library(CorLevelPlot)
library(tidyverse)
library(igraph)
library(remotes)
library(fgsea)
library(data.table)
library(ggplot2)
library(viridis)
library(ggpubr)
library(googledrive)
allowWGCNAThreads()
```

### Options and define variables

```{r options and define variables, warning=FALSE, message=FALSE}
myCor <- "cor"
power <- 11.5
myMergeCutHeight <- 0.05 
myDeepSplit <- 2 
minModSize <- 20 
enforceMMS <- FALSE
cor.pval <- 0.05
```

### Load ExpressionSet

```{r load cpm eset, warning=FALSE, message=FALSE}
#local file: "PfSPZ_cpm_ExpressionSet_230x23768_allGroups_bothBatches_delta_rmBatchFX_06082021_TMT.rds"

temp <- tempfile(fileext = ".rds")
dl <- drive_download(
  as_id("17xx0YaggLiyWdJc9rqA1nkPSE7dj05p0"), path = temp, overwrite = TRUE)
x <- readRDS(file = dl$local_path)
dim(x)
```

### Make weighted gene correlation matrix based on full data set

```{r weighted gene correlation matrix based on full data set, message=FALSE, warning=FALSE}
WGCNA_matrix <- t(exprs(x))
blockSize(ncol(WGCNA_matrix), rectangularBlocks = TRUE, maxMemoryAllocation = 4^31)
par(mfrow=c(1,1))
plotClusterTreeSamples(datExpr=WGCNA_matrix)
powers <- seq(4,20,by=0.5)
sft <- pickSoftThreshold(WGCNA_matrix, powerVector = powers, corFnc = myCor, verbose = 5, networkType ="signed", blockSize = ncol(WGCNA_matrix))
sft$powerEstimate
par(mfrow=c(1,1))
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     xlab='Soft Threshold (power)',ylab='Scale Free Topology Model Fit,signed R²',
     type='n', main = paste('Scale independence'));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     labels=powers,cex=1,col='red'); abline(h=0.90,col='red')
```

### Run an automated network analysis

```{r calculation of adjacency matrix, message=FALSE, warning=FALSE}
net <- blockwiseModules(WGCNA_matrix,
                        power=power,
                        deepSplit=myDeepSplit,
                        minModuleSize=minModSize,
                        TOMType="none", 
                        mergeCutHeight=myMergeCutHeight,
                        TOMDenom="mean",
                        detectCutHeight=0.995,
                        corType="pearson",
                        networkType="signed",
                        pamStage=TRUE,
                        pamRespectsDendro=TRUE,
                        reassignThresh=0.05,
                        verbose=5,
                        saveTOMs=FALSE,
                        maxBlockSize=ncol(WGCNA_matrix),
                        nThreads = 0)

# Summary Module Table
nModules <- length(table(net$colors))-1
modules <- cbind(colnames(as.matrix(table(net$colors))),table(net$colors))
orderedModules <- cbind(Mnum=paste("M",seq(1:nModules),sep=""),Color=labels2colors(c(1:nModules)))
modules <- modules[match(as.character(orderedModules[,2]),rownames(modules)),]
tmpMEs <- MEs <- net$MEs
colnames(tmpMEs) <- paste("ME",colnames(MEs),sep="")
kMEdat <- signedKME(WGCNA_matrix, tmpMEs, corFnc=myCor) #calculate (signed) eigengene-based connectivity, also known as module membership
WGCNA_dat <- cbind(fData(x)$GeneSymbol, colnames(WGCNA_matrix),net$colors,kMEdat) %>%
  as.data.frame() %>%
  dplyr::rename(GeneSymbol = "fData(x)$GeneSymbol") %>%
  dplyr::rename(ENSEMBLID = "colnames(WGCNA_matrix)") %>%
  dplyr::rename(ModuleColors = "net$colors")
```

### Correlate modules with traits

```{r correlate modules with traits, message=FALSE, warning=FALSE}
# Define numbers of genes and samples
nGenes = ncol(WGCNA_matrix)
nSamples = nrow(WGCNA_matrix)

datvar <- pData(x) %>%
  dplyr::select(PATID, SEQBATCH, site, SEX, age.vax1, mal.vax.1, treat, mal.atp.3, tte.mal.atp.6, mal.dvax, mal.dvax.tot, pfcsp_pre, pfcsp_post, log2FC_CSPAb) %>%
  mutate('Gender (female)' = factor(ifelse(SEX == "F", 1, 0))) %>%
  mutate('Site (Siaya)' = factor(ifelse(site == "Siaya", 1, 0))) %>%
  dplyr::rename('Pf infection at first vax' = "mal.vax.1") %>%
  mutate(pfcsp_pre = ifelse(is.na(pfcsp_pre), median(pfcsp_pre, na.rm=TRUE), pfcsp_pre)) %>%
  mutate(pfcsp_post = ifelse(is.na(pfcsp_post), median(pfcsp_post, na.rm=TRUE), pfcsp_post)) %>%
  mutate(mal.dvax.tot = ifelse(is.na(mal.dvax.tot), median(mal.dvax.tot, na.rm=TRUE), mal.dvax.tot)) %>%
  mutate('pre-vax anti-CSP IgG' = log10(pfcsp_pre+1)) %>%
  mutate('post-vax anti-CSP IgG' = log10(pfcsp_post+1)) %>%
  mutate('log2FC anti-CSP IgG' = log2((pfcsp_post+1)/(pfcsp_pre+1))) %>%
  mutate('1.8 x 10^6 PfSPZ' = factor(ifelse(treat == "1.8 x 10^6 PfSPZ", 1, 0))) %>%
  mutate('parasitemic events during vax period' = mal.dvax.tot) %>%
  mutate('uninfected, 3 months' = factor(ifelse(mal.atp.3 == 0, 1, 0))) %>%
  dplyr::rename('days to first parasitemia' = "tte.mal.atp.6") %>%
  mutate(Age = age.vax1) %>%
  dplyr::select(PATID, Age, site, SEX, treat, 'pre-vax anti-CSP IgG', 'parasitemic events during vax period', 'uninfected, 3 months', 'days to first parasitemia', 'log2FC anti-CSP IgG') %>% #delta
  as_tibble() %>%
  column_to_rownames(var = "PATID")

modTraitCor <- cor(orderMEs(net$MEs), datvar, use = "p")
modTraitP <- corPvalueStudent(modTraitCor, nSamples)
#Since we have a moderately large number of modules and traits, a suitable graphical representation will help in reading the table. We color code each association by the correlation value: Will display correlations and their p-values

#Select out only modules that have P<0.05 in Protection
modTraitP.temp <- modTraitP %>%
  as.data.frame() %>%
  rownames_to_column(var = "Module") %>%
  filter(.$'uninfected, 3 months' < cor.pval | .$'days to first parasitemia' < cor.pval)
modTraitCor.select <- modTraitCor[modTraitP.temp$Module,]
modTraitP.select <- modTraitP[modTraitP.temp$Module,]
textMatrix <- paste(signif(modTraitCor.select, 2), "\n(P=",
                   signif(modTraitP.select, 1), ")", sep = "")
dim(textMatrix) <- dim(modTraitCor.select)

topmodules <- chooseTopHubInEachModule(WGCNA_matrix, net$colors, omitColors = "grey", power = 12.5, type ="signed")
```

### Display the correlation values within a heatmap plot (original Figure 4B of JCI revision)

```{r plot module trait correlations heatmap, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=8}
par(mar = c(11, 9, 1, 1))
labeledHeatmap(Matrix = modTraitCor.select, xLabels = names(datvar),
               yLabels = rownames(modTraitCor.select), ySymbols = rownames(modTraitCor.select),
               colorLabels =FALSE,colors=blueWhiteRed(100),textMatrix=textMatrix,
               setStdMargins = FALSE, zlim = c(-1,1),
               main = paste("Module-trait relationships"),xLabelsAngle = 45) 
```
 
### Identify hub genes

```{r id hub genes, warning=FALSE, message=FALSE}
myColors <- gsub("ME", "", rownames(modTraitCor.select))
topmodules <- chooseTopHubInEachModule(WGCNA_matrix, net$colors, omitColors = "grey", power = 12.5, type ="signed")
mytopmodules <- topmodules[myColors] %>%
  as.data.frame() %>%
  dplyr::rename(EnsemblID = ".") %>%
  rownames_to_column("module_label") %>%
  as_tibble() %>%
  left_join(., fData(x) %>%
              dplyr::select(EnsemblID, GeneSymbol), by = "EnsemblID")
devtools::source_url("https://github.com/jtlovell/limmaDE2/blob/master/R/wgcna2igraph.R?raw=TRUE")
graph <- wgcna2igraph(net = net, WGCNA_matrix, modules2plot = myColors,
                      colors2plot = myColors,
                      kME.threshold = 0.5, adjacency.threshold = 0.1,
                      adj.power = power, verbose = T,
                      node.size = 1, frame.color = NA, node.color = scales::muted("red"),
                      edge.alpha = .7, edge.width = 0.5)
hubscores <- hub_score(graph, scale = TRUE, weights = NULL,
  options = arpack_defaults)
```

### Top modules and hub genes (rownames for Figure 4E of pre-print)

```{r display my topmodules, echo=FALSE}
knitr::kable(mytopmodules)
```

### Plot network graph of significant modules (Figure 4C of JCI revision)

Network graphs of significant modules containing nodes (red dots) and edges (lines) meeting minimum thresholds. Correlations between nodes in different modules are shown as black edges.

```{r plot networkd graph, message=FALSE, warning=FALSE, fig.align='center', fig.width=8, fig.height=8, echo=FALSE}
plot(graph)
```

### Make X-Y scatterplots between MEs and variables

This was requested by a reviewer.

First find significant Spearman correlations (p<0.05)

```{r scatterplots between MEs and variables}
all_modules <- topmodules %>%
  as.data.frame() %>%
  dplyr::rename(EnsemblID = ".") %>%
  rownames_to_column("module_color") %>%
  as_tibble() %>%
  left_join(., fData(x) %>%
              dplyr::select(EnsemblID, GeneSymbol), by = "EnsemblID")

all_MEs <- MEs %>%  #MEs[,names(lapply(WGCNA_dat_select, nrow))] %>%
  rownames_to_column(var = "subject_id") %>%
  left_join(., datvar %>%
              rownames_to_column(var = "subject_id"),
            by = "subject_id") %>%
  pivot_longer(., cols = c("pre-vax anti-CSP IgG", "parasitemic events during vax period", "days to first parasitemia",  "log2FC anti-CSP IgG"), names_to = "trait", values_to = "trait_value") %>%
  pivot_longer(., cols = contains("ME"), names_to = "module_label", values_to = "module_eigenvalue") %>%
  mutate(module_color = gsub("ME", "", module_label)) %>%
  left_join(., all_modules,
            by = "module_color")

cor_dat_all <- all_MEs %>%
  group_by(GeneSymbol, trait) %>%
  summarize(rho = cor.test(module_eigenvalue, trait_value, method = "spearman")$estimate,
            p = cor.test(module_eigenvalue, trait_value, method = "spearman")$p.value)

cor_dat_signif <- cor_dat_all %>%
  filter(trait == "days to first parasitemia" & p<0.05)

spearman_signif_hub_genes <- cor_dat_signif$GeneSymbol
```

### Limma method

Prepare data for differential module eigengene analysis

```{r prepare data for differential ME expression}
diffME_dat <- orderMEs(net$MEs) %>% 
  rownames_to_column(var = "subject") %>%
  mutate(subject = gsub("\\_0", "", subject)) %>%
  right_join(., datvar %>%
               dplyr::select(-c(Age, "days to first parasitemia")) %>%
               mutate("parasitemic during vax period" = factor(ifelse(.$"parasitemic events during vax period" > 0, "parasitemic", "not_parasitemic"),
                                                      levels = c("not_parasitemic","parasitemic"))) %>%
               mutate("uninfected, 3 months" = factor(.$"uninfected, 3 months", levels = c(0,1),
                                                      labels = c("infected","never infected"))) %>%
               mutate("pre-vax anti-CSP IgG" = factor(ifelse(.$"pre-vax anti-CSP IgG" > 0, "present", "absent"),
                                                      levels = c("absent","present"))) %>%
               mutate("log2FC anti-CSP IgG" = factor(ifelse(.$"log2FC anti-CSP IgG" > 12.5, "high responder", "low responder"),
                                                      levels = c("low responder","high responder"))) %>%
               dplyr::rename("fold-change anti-CSP IgG" = "log2FC anti-CSP IgG") %>%
               rownames_to_column(var = "subject"),
             by = "subject") %>%
  dplyr::select(-c("parasitemic events during vax period")) %>%
  pivot_longer(cols = contains("ME"), names_to = "module", values_to = "MEs") %>%
  pivot_longer(cols = c("pre-vax anti-CSP IgG":"parasitemic during vax period"), names_to = "trait", values_to = "trait_cat") %>%
  arrange(module, site, treat, trait, trait_cat) %>%
  drop_na(trait_cat)

diffME_dat_samplesize <- diffME_dat %>%
  group_by(module, treat, trait, trait_cat) %>%
  summarize(n=n()) %>% 
  ungroup()
```

```{r WGCNA to limma}
pheno_dat <- diffME_dat %>%
  dplyr::select(subject, site, treat, trait, trait_cat) %>%
  distinct(subject, site, treat, trait, trait_cat) %>%
  pivot_wider(names_from = trait, values_from = trait_cat) %>%
  arrange(subject) %>%
  column_to_rownames(var = "subject")  %>%
  droplevels()

feature_dat <- diffME_dat %>%
  dplyr::select(module, MEs) %>%
  distinct(module) %>%
  mutate(module_color = gsub("ME","", module)) %>%
  left_join(., topmodules %>%
  enframe() %>%
  dplyr::rename(EnsemblID = "value",
                module_color = "name") %>%
  left_join(., fData(x) %>%
              dplyr::select(EnsemblID, GeneSymbol), by = "EnsemblID")) %>%
  column_to_rownames(var = "module") %>%
  dplyr::rename(hub_gene = "GeneSymbol")

exprs_dat <- orderMEs(net$MEs) %>% 
  rownames_to_column(var = "subject") %>%
  mutate(subject = gsub("\\_0", "", subject)) %>%
  arrange(subject) %>%
  column_to_rownames(var = "subject") %>%
  dplyr::select(rownames(feature_dat)) %>%
  t() 
  
#check
ifelse(all(colnames(exprs_dat) == rownames(pheno_dat)) &
         all(rownames(exprs_dat) == rownames(feature_dat)),
       "Good to go!",
       "Check for matching names")

#make expression set
wgcna_eset <- ExpressionSet(exprs_dat, phenoData = AnnotatedDataFrame(pheno_dat), featureData = AnnotatedDataFrame(feature_dat))
```

```{r full dataset}
#Determine differences between module eigenvalues as binary using limma

#Pf_baseline
pf_during_vax <- factor(wgcna_eset$`parasitemic during vax period`) #encodes a vector as a factor
treatment <- wgcna_eset$treat
site <- factor(wgcna_eset$site)
design <- model.matrix(~0+pf_during_vax+site+treatment) 
colnames(design)
colnames(design) <- c("uninfected_during_vax", "infected_during_vax","wagai", "lowdose","mediumdose","highdose")
fit <- lmFit(exprs(wgcna_eset), design) # Fit linear models for each gene given a series of arrays.
contrasts <- makeContrasts(infected_during_vax - uninfected_during_vax,
                           levels=design) 
contrasts
fit2 <- contrasts.fit(fit, contrasts)
fit2 <- eBayes(fit2, trend=TRUE)

Pf_during_vax <- topTable(fit2, coef="infected_during_vax - uninfected_during_vax", number = Inf) %>%
  rownames_to_column("module") %>%
  right_join(., feature_dat %>%
               rownames_to_column("module"),
             by = "module") %>%
  mutate(comparison = "infected_vs_uninfected_during_vax") %>%
  dplyr::select(comparison, module, module_color, hub_gene, logFC, P.Value, adj.P.Val)
head(Pf_during_vax)

#prevax_antiCSPIgG
prevax_antiCSPIgG <- factor(wgcna_eset$`pre-vax anti-CSP IgG`)
design <- model.matrix(~0+prevax_antiCSPIgG+site+treatment)
colnames(design)
colnames(design) <- c("noCSPAb_first_vax", "CSPAb_first_vax","wagai","lowdose","mediumdose","highdose")
fit <- lmFit(exprs(wgcna_eset), design) # Fit linear models for each gene given a series of arrays.
contrasts <- makeContrasts(CSPAb_first_vax - noCSPAb_first_vax,
                           levels=design) 
contrasts
fit2 <- contrasts.fit(fit, contrasts)
fit2 <- eBayes(fit2, trend=TRUE)

CSPAb_baseline <- topTable(fit2, coef="CSPAb_first_vax - noCSPAb_first_vax", number = Inf) %>%
  rownames_to_column("module") %>%
  right_join(., feature_dat %>%
               rownames_to_column("module"),
             by = "module") %>%
  mutate(comparison = "present_vs_absent_baseline") %>%
  dplyr::select(comparison, module, module_color, hub_gene, logFC, P.Value, adj.P.Val)
head(CSPAb_baseline)

#protection
outcome_3mos <- factor(wgcna_eset$`uninfected, 3 months`)
design <- model.matrix(~0+outcome_3mos+site+treatment)
colnames(design)
colnames(design) <- c("not_protected","protected", "wagai", "lowdose","mediumdose","highdose")
fit <- lmFit(exprs(wgcna_eset), design) # Fit linear models for each gene given a series of arrays.
contrasts <- makeContrasts(protected - not_protected,
                           levels=design) 
contrasts
fit2 <- contrasts.fit(fit, contrasts)
fit2 <- eBayes(fit2, trend=TRUE)

p_vs_np_3mos <- topTable(fit2, coef="protected - not_protected", number = Inf) %>%
  rownames_to_column("module") %>%
  right_join(., feature_dat %>%
               rownames_to_column("module"),
             by = "module") %>%
  mutate(comparison = "protected_vs_not_protected") %>%
  dplyr::select(comparison, module, module_color, hub_gene, logFC, P.Value, adj.P.Val)
head(p_vs_np_3mos)

#CSP Ab response 
FC_CSPAb <- factor(wgcna_eset$`fold-change anti-CSP IgG`)
design <- model.matrix(~0+FC_CSPAb+site+treatment) 
colnames(design)
colnames(design) <- c("low_responder","high_responder","wagai","lowdose","mediumdose","highdose")
fit <- lmFit(exprs_dat, design) # Fit linear models for each gene given a series of arrays.
contrasts <- makeContrasts(high_responder - low_responder,
                           levels=design) 
contrasts
fit2 <- contrasts.fit(fit, contrasts)
fit2 <- eBayes(fit2, trend=TRUE)
hi_vs_low_CSP <- topTable(fit2, coef="high_responder - low_responder", number = Inf) %>%
  rownames_to_column("module") %>%
  right_join(., feature_dat %>%
               rownames_to_column("module"),
             by = "module") %>%
  mutate(comparison = "hi_vs_low_CSP") %>%
  dplyr::select(comparison, module, module_color, hub_gene, logFC, P.Value, adj.P.Val)
head(hi_vs_low_CSP)

all_module_trait_dat <- rbind(Pf_during_vax, CSPAb_baseline, hi_vs_low_CSP, p_vs_np_3mos) %>%
  arrange(P.Value)

p_vs_np_3mos_select <- p_vs_np_3mos %>%
  filter(P.Value<0.05)

all_module_trait_hm_dat <- all_module_trait_dat %>%
  filter(hub_gene %in% p_vs_np_3mos_select$hub_gene) %>%
  dplyr::select(comparison, module_color, hub_gene, logFC) %>%
  pivot_wider(names_from = comparison, values_from = logFC) %>%
  column_to_rownames(var = "hub_gene")

#lapply(WGCNA_dat_select, nrow)
```

```{r prepare heatmap wgcna limma, fig.align='center', fig.height=5, fig.width=7}
### Heatamp for WGCNA Limma data
#Look only at modules that were significantly different between P vs NP, which is RIOK3 and SEC62

library(tidyverse)
library(ComplexHeatmap)

p_vs_np_3mos_select <- p_vs_np_3mos %>%
  filter(P.Value < 0.05) %>%
  dplyr::select(comparison, hub_gene, module_color, logFC, P.Value, adj.P.Val)

Pf_during_vax_select <- Pf_during_vax %>%
  filter(hub_gene %in% p_vs_np_3mos_select$hub_gene) %>%
  dplyr::select(comparison, hub_gene, module_color, logFC, P.Value, adj.P.Val)

CSPAb_baseline_select <- CSPAb_baseline %>%
  filter(hub_gene %in% p_vs_np_3mos_select$hub_gene) %>%
  dplyr::select(comparison, hub_gene, module_color, logFC, P.Value, adj.P.Val)

hi_vs_low_CSP_select <- hi_vs_low_CSP %>%
  filter(hub_gene %in% p_vs_np_3mos_select$hub_gene) %>%
  dplyr::select(comparison, hub_gene, module_color, logFC, P.Value, adj.P.Val)
  

all_module_trait_binary_hm_dat <- bind_rows(p_vs_np_3mos_select,
                                     Pf_during_vax_select,
                                     CSPAb_baseline_select,
                                     hi_vs_low_CSP_select)

all_module_trait_binary_hm_mat <- all_module_trait_binary_hm_dat %>%
  dplyr::select(comparison, hub_gene, logFC) %>%
  pivot_wider(names_from = "comparison", values_from = "logFC", id_cols = hub_gene) %>%
  column_to_rownames(var = "hub_gene") %>%
  as.matrix()


clab <- list(
  "hub_gene" = c("RIOK3" = "midnightblue", "SEC62" = "brown4")
  )

clab <- rev(clab)

row_ha_df <-  all_module_trait_binary_hm_dat %>%
  filter(comparison == "protected_vs_not_protected") %>%
  dplyr::select(hub_gene)
row_ha <- rowAnnotation(df = row_ha_df, col = clab, na_col = "lavender", annotation_name_gp = gpar(fontsize = 7),
                        simple_anno_size = unit(0.2, "inches"))

paletteLength <- 50
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1*max(abs(all_module_trait_binary_hm_mat)), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(all_module_trait_binary_hm_mat)/paletteLength, max(abs(all_module_trait_binary_hm_mat)), length.out=floor(paletteLength/2)))
myColor <- colorRampPalette(c("#548FCB", "white", "#B83434"))(length(myBreaks))

my_hm <- Heatmap(all_module_trait_binary_hm_mat,
        col = circlize::colorRamp2(myBreaks, myColor),
        color_space = "LAB",
        row_names_side = "left",
        row_dend_side = "right",
        left_annotation = row_ha,
        border = TRUE)
```

```{r draw hm, fig.align='center', fig.width=4, fig.height=4}
draw(my_hm)
```

```{r save Figure 4B Revised to WGCNA limma, include=FALSE, echo=FALSE, eval=FALSE}
cairo_pdf(file = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Figures JCI resubmission/Figure 4B Revised to WGCNA limma SEC62 and RIOK3.pdf", width = 5, height = 4)
draw(my_hm)
dev.off()
```

```{r make scatter plots for all significant continuous and binary variables}
my_hub_genes <- c(spearman_signif_hub_genes, unique(all_module_trait_binary_hm_dat$hub_gene))
my_scatter_plots <- all_MEs %>%
  filter(GeneSymbol %in% my_hub_genes) %>%
  mutate(trait = factor(trait, levels = c("pre-vax anti-CSP IgG", "parasitemic events during vax period",  "log2FC anti-CSP IgG", "days to first parasitemia"))) %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels =  my_hub_genes)) %>%
  ggplot(., aes(x = trait_value, y = module_eigenvalue)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("trait value") +
  ylab("module eigenvalue") +
  stat_cor(method = "spearman",
           cor.coef.name = "rho") +
  theme_bw() +
  ggh4x::facet_grid2(GeneSymbol~trait, scales = "free", switch = "y")
```


```{r plot scatter plots, fig.align='center', fig.height=16, fig.width=10, include=FALSE, eval=FALSE, echo=FALSE}
my_scatter_plots
```

### Plot individual beeswarmplot plots for protected vs non-protected

```{r plot significant scatter plots, fig.align='center', fig.width=8, fig.height=8}

beeswarmplot_dat <- orderMEs(net$MEs) %>% 
  rownames_to_column(var = "subject") %>%
  mutate(subject = gsub("\\_0", "", subject)) %>%
  right_join(., pData(wgcna_eset) %>%
               dplyr::select(-c(site, treat)) %>%
               rownames_to_column(var = "subject"),
             by = "subject") %>%
  pivot_longer(cols = contains("ME"), names_to = "module_label", values_to = "module_eigenvalue") %>%
  mutate(module_color = gsub("ME", "", module_label)) %>%
    left_join(., all_modules,
              by = "module_color") %>%
  filter(GeneSymbol %in% my_hub_genes)
```

```{r beeswarmplot factor data, fig.align='center', fig.width=12, fig.height=5}
library(tidyverse)
library(broom)
beeswarmplot_dat_factor <- beeswarmplot_dat %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels = my_hub_genes)) %>%
  mutate(protected_3mos = ifelse(`uninfected, 3 months` == "infected", "NP", "P")) %>%
  pivot_longer(cols = c("fold-change anti-CSP IgG":"uninfected, 3 months", protected_3mos), names_to = "trait", values_to = "value")  %>%
  mutate(trait = factor(trait, levels = c("parasitemic during vax period",
                                          "pre-vax anti-CSP IgG",
                                          "uninfected, 3 months",
                                          "protected_3mos",
                                          "fold-change anti-CSP IgG"))) %>%
  filter(trait == "protected_3mos")

beeswarmplot_dat_factor_norm_test <- beeswarmplot_dat_factor %>%
  group_by(GeneSymbol, trait)%>% 
  do(tidy(shapiro.test(.$module_eigenvalue))) %>% 
  ungroup() %>%
  dplyr::select(-method) %>%
  mutate(is_normal = ifelse(p.value<0.05, "no","yes"))
  
beeswarmplot_dat_factor_n <- beeswarmplot_dat_factor %>%
  group_by(GeneSymbol, trait) %>%
  summarise(n = n())

data_summary <- function(x) {
  m <- mean(x, na.rm=TRUE)
  sem <-sd(x, na.rm=TRUE)/sqrt(sum(!is.na(x)))
  ymin<-m-1.96*sem
  ymax<-m+1.96*sem
  return(c(y=m,ymin=ymin,ymax=ymax))
}


all_beeswarm_plot <- beeswarmplot_dat_factor %>%
  ggplot(., aes(x=value, y=module_eigenvalue)) +
  ggbeeswarm::geom_beeswarm(alpha = 0.5, color = "lightblue") +
  stat_summary(fun="mean", geom="segment", mapping=aes(xend=..x.. - 0.1, yend=..y..), linewidth = 0.5)+
  stat_summary(fun="mean", geom="segment", mapping=aes(xend=..x.. + 0.1, yend=..y..), linewidth = 0.5) +
  stat_summary(fun.data=data_summary, geom="errorbar", width=0.1) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
  ylab("module eigenvalue") +
  xlab("") +
  theme_bw() +
  ggh4x::facet_grid2(GeneSymbol~trait, scales = "free", switch = "y") #+
  # theme(axis.text = element_text(colour = "black"),
  #       strip.background = element_blank(),
  #       axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
  #       plot.title = element_text(size=8))
```

#### Figure S6A of revised manuscript

```{r plot all_beeswarm_plot, fig.align='center', fig.height=6, fig.width=2, include=FALSE, eval=FALSE, echo=FALSE}
all_beeswarm_plot
```

```{r save scatter pltos and beeswarm arrange, fig.align='center', fig.height=12, fig.width=12, include=FALSE, eval=FALSE, echo=FALSE}
pdf(file = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Figures JCI resubmission/Fig SS6A JCI revised WGCNA Spearman scatterplot and limma boxplots.pdf", height = 12, width = 10)
ggarrange(my_scatter_plots, all_beeswarm_plot, widths = c(4,1.15))
dev.off()
```

```{r scatter pltos and beeswarm arrange, fig.align='center', fig.height=12, fig.width=12}
ggarrange(my_scatter_plots, all_beeswarm_plot, widths = c(4,1.15))
```

### Make revised heatmap (Figure 4B, JCI revision)

This will show Spearman's rho as color scale.

```{r prepare new heatmap}
cor_dat <- my_scatter_plots$data %>%
  group_by(GeneSymbol, trait) %>%
  summarize(rho = cor.test(module_eigenvalue, trait_value, method = "spearman")$estimate,
            p = cor.test(module_eigenvalue, trait_value, method = "spearman")$p.value)
hm_cor_mat <- cor_dat %>%
  dplyr::select(-p) %>%
  pivot_wider(names_from = trait, values_from = rho) %>%
  column_to_rownames(var = "GeneSymbol") %>%
  as.matrix()
mytopmodules_list <- all_modules %>%
  filter(GeneSymbol %in% my_hub_genes) %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels = my_hub_genes)) %>%
  dplyr::select(GeneSymbol, module_color) %>%
  deframe()

clab <- list(
  "hub_gene" = mytopmodules_list
  )
clab <- rev(clab)

row_ha_df <-  all_modules %>%
  filter(GeneSymbol %in% my_hub_genes) %>%
  dplyr::select(GeneSymbol) %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels = my_hub_genes)) %>%
  arrange(GeneSymbol) %>%
  dplyr::rename(hub_gene = "GeneSymbol")

hm_cor_mat <- hm_cor_mat[levels(row_ha_df$hub_gene),]

row_ha <- rowAnnotation(df = row_ha_df, col = clab, na_col = "lavender", annotation_name_gp = gpar(fontsize = 7),
                        simple_anno_size = unit(0.1, "inches"),
                        show_legend = FALSE)

paletteLength <- 50
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1*max(abs(hm_cor_mat)), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(hm_cor_mat)/paletteLength, max(abs(hm_cor_mat)), length.out=floor(paletteLength/2)))
myColor <- colorRampPalette(c("#548FCB", "white", "#B83434"))(length(myBreaks))

my_hm <- Heatmap(hm_cor_mat,
        col = circlize::colorRamp2(myBreaks, myColor),
        color_space = "LAB",
        row_names_side = "left",
        row_dend_side = "right",
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        left_annotation = row_ha,
        border = TRUE)
```

### Limma heatmap for P vs NP only

```{r make Limma heatmap for P vs NP only}
 hm_limma_mat <- p_vs_np_3mos %>%
  filter(hub_gene %in% my_hub_genes) %>%
  mutate(trait = "protection_3mos") %>%
  dplyr::select(hub_gene, trait, logFC) %>%
  pivot_wider(names_from = trait, values_from = logFC) %>%
  column_to_rownames(var = "hub_gene") %>%
  as.matrix(., nrow(.), byrow=TRUE)
  
mytopmodules_list <- all_modules %>%
  filter(GeneSymbol %in% my_hub_genes) %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels = my_hub_genes)) %>%
  dplyr::select(GeneSymbol, module_color) %>%
  deframe()

clab <- list(
  "hub_gene" = mytopmodules_list
  )
clab <- rev(clab)

row_ha_df <-  all_modules %>%
  filter(GeneSymbol %in% my_hub_genes) %>%
  dplyr::select(GeneSymbol) %>%
  mutate(GeneSymbol = factor(GeneSymbol, levels = my_hub_genes)) %>%
  arrange(GeneSymbol) %>%
  dplyr::rename(hub_gene = "GeneSymbol")

hm_limma_mat <- hm_limma_mat[levels(row_ha_df$hub_gene), 1, drop = FALSE]

row_ha <- rowAnnotation(df = row_ha_df, col = clab, na_col = "lavender", annotation_name_gp = gpar(fontsize = 7),
                        simple_anno_size = unit(0.1, "inches"))

paletteLength <- 50
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1*max(abs(hm_limma_mat)), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(hm_limma_mat)/paletteLength, max(abs(hm_limma_mat)), length.out=floor(paletteLength/2)))
myColor <- colorRampPalette(c("#548FCB", "white", "#B83434"))(length(myBreaks))

my_limma_hm <- Heatmap(hm_limma_mat,
        col = circlize::colorRamp2(myBreaks, myColor),
        color_space = "LAB",
        cluster_rows = FALSE,
        row_names_side = "left",
        row_dend_side = "right",
        #left_annotation = row_ha,
        border = TRUE)
```

```{r view combined heatmaps, fig.align='center', fig.width=5, fig.height=4}
my_hm + my_limma_hm
```
```{r save combined heatmaps, fig.align='center', fig.width=5, fig.height=4, eval=FALSE, include=FALSE, echo=FALSE}
pdf(file = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Figures JCI resubmission/Fig 4B JCI revised WGCNA Spearman and limma heatmap.pdf", height = 4, width = 3.75)
my_hm + my_limma_hm
dev.off()
```

```{r save heatmap data, eval=FALSE, include=FALSE, echo=FALSE}
combined_hm_mat <- as.data.frame(hm_cor_mat) %>%
  rownames_to_column(var = "hub_gene") %>%
  left_join(., as.data.frame(hm_limma_mat) %>%
              rownames_to_column(var = "hub_gene"),
            by = "hub_gene")
writexl::write_xlsx(combined_hm_mat, path = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Data for all Plots JCI Resubmission/Figure 4B Heatmap Data Continuous and Binary Limma.xlsx")

```

### Redo network graphs

```{r id hub genes jci revision, warning=FALSE, message=FALSE}
foo <- all_modules %>%
  filter(GeneSymbol %in% my_hub_genes)
myColors <- foo$module_color
topmodules <- chooseTopHubInEachModule(WGCNA_matrix, net$colors, omitColors = "grey", power = 12.5, type ="signed")
mytopmodules <- topmodules[myColors] %>%
  as.data.frame() %>%
  dplyr::rename(EnsemblID = ".") %>%
  rownames_to_column("module_label") %>%
  as_tibble() %>%
  left_join(., fData(x) %>%
              dplyr::select(EnsemblID, GeneSymbol), by = "EnsemblID")
devtools::source_url("https://github.com/jtlovell/limmaDE2/blob/master/R/wgcna2igraph.R?raw=TRUE")
graph <- wgcna2igraph(net = net, WGCNA_matrix, modules2plot = myColors,
                      colors2plot = myColors,
                      kME.threshold = 0.5, adjacency.threshold = 0.1,
                      adj.power = power, verbose = T,
                      node.size = 1, frame.color = NA, node.color = scales::muted("red"),
                      edge.alpha = .7, edge.width = 0.5)
hubscores <- hub_score(graph, scale = TRUE, weights = NULL,
  options = arpack_defaults)
```

### Plot network graph of significant modules (Figure 4C of JCI revision)

Network graphs of significant modules containing nodes (red dots) and edges (lines) meeting minimum thresholds. Correlations between nodes in different modules are shown as black edges.

```{r plot networkd graph jci revision, message=FALSE, warning=FALSE, fig.align='center', fig.width=8, fig.height=8}
plot(graph)
```

```{r save plot networkd graph jci revision, message=FALSE, warning=FALSE, eval=FALSE, include=FALSE, echo=FALSE}
pdf(file = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Figures JCI resubmission/Fig 4C JCI revised WGCNA network plots.pdf", height = 4, width = 3)
plot(graph)
dev.off()
```

List number of genes per module

```{r id modules that are significant than pull out gene list, warning=FALSE, message=FALSE}
downselected_MEs <- paste0("ME", myColors)
WGCNA_dat_select <- c()
for(i in downselected_MEs){
  module.color <- sub("ME","", i)
  module.colname <- paste0("kME", i)
  WGCNA_dat_select[[i]] <- WGCNA_dat %>% 
    filter(ModuleColors == module.color) %>%
    dplyr::select(GeneSymbol, all_of(module.colname))
}
lapply(WGCNA_dat_select, nrow)
```

```{r FGSEA on WGCNA Results, warning=FALSE, message=FALSE, include=FALSE, echo=FALSE, eval=FALSE}
### FGSEA on WGCNA Results

#rank by module membership

#closeAllConnections()
minSize <- 5
# Make rank list; ranked by ModuleMembership correlation
ranks <- GSEA_baseline_bound_df <- c()
devtools::source_url("https://github.com/TranLab/ModuleLists/blob/main/NamedGeneRankList2GseaTable.R?raw=TRUE")
for(k in names(WGCNA_dat_select)){
  WGCNA_dat_select[[k]] <- WGCNA_dat_select[[k]][order(WGCNA_dat_select[[k]][,2], decreasing = TRUE),]
  ranks[[k]] <- WGCNA_dat_select[[k]][,2]
  names(ranks[[k]]) <- WGCNA_dat_select[[k]]$GeneSymbol
  GSEA_baseline_bound_df[[k]] <- NamedGeneRankList2GseaTable(rankedgenes = ranks[[k]], geneset = "all", output_directory = tempdir(),
                                                        filename_prefix = paste0("FGSEA_Mod_Corr_Protect_3_mos_", k,
                                                                                 "_minSize", minSize), scoreType = "pos", minSize = minSize, fixed_seed = TRUE)
  }
```

```{r prepare data wgcna gsea, warning=FALSE, message=FALSE, include=FALSE, echo=FALSE, eval=FALSE}
### WCGNA GSEA Results

#delta analysis

myModuleTypes <- c("MSigDB_Hallmark_v7.4", "MSigDB_C2_kegg_v7.4", "highBTMs", "lowBTMs", "MonacoModules", "BloodGen3Module")
myGSEAClusterPlotDat <- GSEA_baseline_bound_df$MEpaleturquoise %>%
  mutate(module_hub = "BTLA") %>%
  bind_rows(., GSEA_baseline_bound_df$MElightgreen %>%
              mutate(module_hub = "CD22") ) %>%
  bind_rows(., GSEA_baseline_bound_df$MEmistyrose %>%
              mutate(module_hub = "LTF")) %>%
  bind_rows(., GSEA_baseline_bound_df$MElightblue4 %>%
                mutate(module_hub = "NKG2-E")) %>%  
  bind_rows(., GSEA_baseline_bound_df$MEbrown4 %>%
              mutate(module_hub = "SEC62")) %>%
  bind_rows(., GSEA_baseline_bound_df$MEmidnightblue %>%
              mutate(module_hub = "RIOK3")) %>%
  mutate(neglogpadj = -log10(padj)) %>%
  mutate(module_hub = gsub("2-E", "2E", module_hub)) %>%
  mutate(pathway = gsub("VS", "v", pathway)) %>%
  mutate(pathway = gsub("Vd", "Vδ", pathway)) %>%
  mutate(pathway = gsub("gd", "γδ", pathway)) %>%
  mutate(pathway = sub(".*?\\_", "", pathway)) %>%
  mutate(pathway = fct_reorder(pathway, NES, .desc = TRUE))  %>%
  dplyr::arrange(desc(NES)) %>%
  mutate(TextLabelColor = ifelse(module_type == "lowBTMs", scales::muted("red"),
                                 ifelse(module_type == "highBTMs", scales::muted("blue"),
                                        ifelse(module_type == "BloodGen3Module", "orange",
                                               ifelse(module_type == "MonacoModules", "black",
                                                      ifelse(module_type == "highBTMs", scales::muted("blue"), 
                                                             ifelse(module_type == "MSigDB_C2_kegg_v7.4", scales::muted("green"),
                                                                    ifelse(module_type == "MSigDB_C2_kegg_v7.4", scales::muted("purple"), "gray")))))))) %>%
  filter(padj < 0.05) %>%
  filter(module_type %in% myModuleTypes) %>%
  droplevels()
```

```{r prepare , warning=FALSE, message=FALSE, fig.width=6, fig.height=6, echo=FALSE, eval=FALSE, include=FALSE}
### GSEA Bubble plot (Figure S6B in JCI Revision)

# Gene set enrichment analysis of genes ranked by membership within indicated modules which were determined by
# weight gene correlation network analysis (WGCNA) of whole-blood Δ transcriptomes.

addSmallLegend <- function(myPlot, pointSize = 2.5, textSize = 4, spaceLegend = 0.5) {
    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}

myfont <- "Helvetica"
bubble_max_size <- 6
basetextsize <- 8
colorlabels <- myGSEAClusterPlotDat$TextLabelColor
myGSEAClusterPlot <- myGSEAClusterPlotDat %>%
  ggplot(., aes(x = module_hub, y = pathway)) +
  geom_point(aes(size=neglogpadj, fill = NES), alpha = 0.65, shape=21, stroke = 0.25) +
  scale_size_area(name = expression(-log[10]~adj.~p~value), max_size = bubble_max_size) +
  viridis::scale_fill_viridis(option= "A", begin = 0.25, end = 0.75, alpha = 0.8, direction = -1, name = "NES") +
  hrbrthemes::theme_ipsum_es(base_family = myfont, base_size = basetextsize) +
  scale_x_discrete(limits=rev) +
  scale_y_discrete(position = "right") +
  ylab("pathway/module") +
  xlab("WGCNA hub gene") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=0)) +
  coord_flip()
```


```{r plot delta bubble, fig.align='center', fig.height=5, fig.width=6, echo=FALSE, eval=FALSE, include=FALSE}
# Apply on original plot
addSmallLegend(myGSEAClusterPlot)
```

### Over-representation Analysis

```{r WGCNA ora, message=FALSE, warning=FALSE}
#closeAllConnections()
source("https://raw.githubusercontent.com/TranLab/kspzv1-systems/main/helper/ApplyORA2Genesets.R")
myuniverse <- unique(fData(x)[fData(x)$EnsemblID %in% colnames(WGCNA_matrix),]$GeneSymbol)
ORA_baseline_bound_df <- c()
minSize <- 20
downselected_MEs
#Combine similar modules skyblue1, mediumpurple1, thistle3 in to one
WGCNA_dat_select2 <- list()
WGCNA_dat_select2$NKG2E <- WGCNA_dat_select$MElightblue4
WGCNA_dat_select2$LTF <- WGCNA_dat_select$MEmistyrose
WGCNA_dat_select2$BLTA_CD22 <- data.table::rbindlist(list(WGCNA_dat_select$MEpaleturquoise,
                                                WGCNA_dat_select$MElightgreen)) %>%
  as.data.frame() %>%
  dplyr::rename(kMEMEall = "kMEMEpaleturquoise") 
WGCNA_dat_select2$RIOK3_SEC62 <- data.table::rbindlist(list(WGCNA_dat_select$MEmidnightblue,
                                                WGCNA_dat_select$MEbrown4)) %>%
  as.data.frame() %>%
  dplyr::rename(kMEMEall = "kMEMEmidnightblue")
for(k in names(WGCNA_dat_select2)){
  WGCNA_dat_select2[[k]] <- WGCNA_dat_select2[[k]][order(WGCNA_dat_select2[[k]][,2], decreasing = TRUE),]
  ORA_baseline_bound_df[[k]] <- ApplyORA2Genesets(genelist = WGCNA_dat_select2[[k]]$GeneSymbol,
                                                  geneset = "all",
                                                  universe = myuniverse,
                                                  output_directory = tempdir(),
                                                  filename_prefix = paste0("ORA_Mod_Corr_Protect_3_mos_", k,
                                                                           "_minSize", minSize),
                                                  minSize = minSize)
  }


NKG2E_ORA_baseline_bound <- bind_rows(ORA_baseline_bound_df$NKG2E, .id = "module_type") %>%
  mutate(module = "lightblue4") %>%
  mutate(module_size = nrow(WGCNA_dat_select$MElightblue4)) %>%
  mutate(hub_gene = "NKG2E") 
LTF_ORA_baseline_bound <- bind_rows(ORA_baseline_bound_df$LTF, .id = "module_type") %>%
  mutate(module = "mistyrose") %>%
  mutate(module_size = nrow(WGCNA_dat_select$MEmistyrose)) %>%
  mutate(hub_gene = "LTF")
BLTA_CD22_ORA_baseline_bound <- bind_rows(ORA_baseline_bound_df$BLTA_CD22, .id = "module_type") %>%
  mutate(module = "paleturquoise and lightgreen") %>%
  mutate(module_size = nrow(WGCNA_dat_select2$BLTA_CD22)) %>%
  mutate(hub_gene = "BLTA_CD22")
RIOK3_SEC62_ORA_baseline_bound <- bind_rows(ORA_baseline_bound_df$RIOK3_SEC62, .id = "module_type") %>%
  mutate(module = "midnightblue and brown4") %>%
  mutate(module_size = nrow(WGCNA_dat_select2$RIOK3_SEC62)) %>%
  mutate(hub_gene = "RIOK3_SEC62")


ORA_baseline_allbound <- bind_rows(NKG2E_ORA_baseline_bound,
                                  LTF_ORA_baseline_bound,
                                  BLTA_CD22_ORA_baseline_bound,
                                  RIOK3_SEC62_ORA_baseline_bound) %>%
  mutate(neglogpadj = -log10(padj)) %>%
  mutate(pct_overlap = 100*(overlap/module_size)) %>%
  dplyr::select(module, module_size, hub_gene, module_type, pathway, overlap,
                pct_overlap, size, overlapGenes, pval, padj, neglogpadj)
```

### Plot WGCNA over-representation results, JCI revision

delta analysis

```{r plotdat wgcna ORA, warning=FALSE, message=FALSE}
myModuleTypes <- c("MSigDB_Hallmark_v7.4", "MSigDB_C2_kegg_v7.4", "highBTMs", "BloodGen3Module")
myORAClusterPlotDat <- ORA_baseline_allbound %>%
  mutate(pathway = gsub("VS", "v", pathway)) %>%
  mutate(pathway = gsub("Vd", "Vδ", pathway)) %>%
  mutate(pathway = gsub("gd", "γδ", pathway)) %>%
  mutate(pathway = sub(".*?\\_", "", pathway)) %>%
  mutate(pathway = fct_reorder(pathway, neglogpadj))  %>%
  arrange(desc(neglogpadj))%>%
  mutate(TextLabelColor = ifelse(module_type == "BloodGen3Module", scales::muted("red"),
                                 ifelse(module_type == "MSigDB_C2_kegg_v7.4", scales::muted("blue"),
                                        ifelse(module_type == "MSigDB_Hallmark_v7.4", "black","gray")))) %>%
  filter(padj < 0.01) %>%
  filter(pct_overlap >= 5) %>%
  filter(module_type %in% myModuleTypes) %>%
  group_by(hub_gene) %>%
  arrange(neglogpadj) %>%
  slice_tail(n = 4) %>%
  ungroup()
```

### Arrange plots

```{r make ggarranged plot, warning=FALSE, message=FALSE}
addSmallLegend <- function(myPlot, pointSize = 1.5, textSize = 3, spaceLegend = 0.3) {
    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.title = element_text(size = textSize), 
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}

scale_begin <- floor(min(myORAClusterPlotDat$pct_overlap, na.rm = TRUE))
scale_end <- ceiling(max(myORAClusterPlotDat$pct_overlap, na.rm = TRUE))

myArrangedPlot <- myORAClusterPlotDat %>%
  mutate(pathway = fct_reorder(pathway, neglogpadj))  %>%
  ggplot(., aes(x = neglogpadj, y = pathway, fill = pct_overlap)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept = 2, color = "red", linetype = "dotted") +
  scale_fill_distiller(direction = 1, breaks = c(0, 10, 20, 30, 40, 50), limits = c(0,50)) +
  ylab("module") +
  theme_classic(base_family = "sans", base_size = 14) +
  theme(legend.position = "bottom",
        plot.margin = unit(c(0,0.5,0,0.5), "cm")) +
  facet_wrap(~hub_gene, scales ="free") +
  theme(strip.background = element_blank())

myfont <- "Helvetica"
bubble_max_size <- 15
basetextsize <- 10
myORABubblePlot <- myORAClusterPlotDat %>%
    mutate(pathway = fct_reorder(pathway, neglogpadj))  %>%
  ggplot(., aes(x = hub_gene, y = pathway)) +
  geom_point(aes(size=pct_overlap, fill = neglogpadj), alpha = 0.65, shape=21, stroke = 0.25) +
  scale_size_area(name = expression(-log[10]~adj.~p~value), max_size = bubble_max_size, breaks = c(1, 5, 10, 20, 40, 60), limits = c(1,75)) +
  viridis::scale_fill_viridis(option= "A", begin = 0.25, end = 0.75, alpha = 0.8, direction = -1, name = "% overlap") +
  hrbrthemes::theme_ipsum_es(base_family = myfont, base_size = basetextsize) +
  scale_x_discrete(limits=rev) +
  scale_y_discrete(position = "right") +
  ylab("pathway/module") +
  xlab("network hub gene(s)") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=0)) +
  coord_flip()
```

### Delta WGCNA Top Modules ORA bubble plots (Figure S6B, JCI revision)
 
```{r plot myORABubblePlot, fig.align='center', fig.width=7, fig.height=7, warning=FALSE, message=FALSE, echo=FALSE}
print(myORABubblePlot)
```

```{r save myORABubblePlot, echo=FALSE, eval=FALSE, include=FALSE}
cairo_pdf(filename = "/Users/tuantran/Library/CloudStorage/OneDrive-IndianaUniversity/Manuscripts/KSPZV1 Manuscript/JCI Resubmission April 2023/Figures JCI resubmission/Fig S6B Delta WCGNA Networks ORA JCI Revision.pdf", width = 6.75, height = 6.75)
myORABubblePlot
dev.off()
```
